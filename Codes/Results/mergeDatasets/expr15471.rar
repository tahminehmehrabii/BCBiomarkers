library(GEOquery)
library(dplyr)
library(data.table)

# Set working directory
setwd("C:/Users/MHR/Desktop/PDAC")

#### Load and process GEO data ####
load_geo_data <- function(gse_id) {
  gse <- getGEO(gse_id, destdir = getwd())[[1]]
  phen <- pData(gse)
  feat <- fData(gse)
  expr <- log2(exprs(gse))
  
  # Edit symbols to match common genes
  commonGenes <- Reduce(intersect, lapply(list(feat$`Gene Symbol`), unique))
  feat$`Gene Symbol` <- sapply(strsplit(feat$`Gene Symbol`, " /// "), function(x) intersect(x, commonGenes)[1])
  feat <- feat[, c("ID", "Gene Symbol")]
  colnames(feat) <- c("ID", "symbol")
  
  expr <- cbind(ID = rownames(expr), expr) %>%
    as.data.frame() %>%
    merge(feat, by = "ID") %>%
    filter(symbol != "") %>%
    distinct(symbol, .keep_all = TRUE) %>%
    column_to_rownames("symbol") %>%
    na.omit()
  
  return(expr)
}

# Load all datasets
expr15471 <- load_geo_data("GSE15471")
expr46234 <- load_geo_data("GSE46234")
expr71989 <- load_geo_data("GSE71989")

#### Align datasets ####
common_genes <- Reduce(intersect, list(rownames(expr15471), rownames(expr46234), rownames(expr71989)))
expr15471 <- expr15471[common_genes, ]
expr46234 <- expr46234[common_genes, ]
expr71989 <- expr71989[common_genes, ]

expr15471 <- t(expr15471) %>% as.data.frame()
expr46234 <- t(expr46234) %>% as.data.frame()
expr71989 <- t(expr71989) %>% as.data.frame()

#### Load phenotypic data ####
load_phenotype <- function(file) {
  phen <- fread(file)
  return(phen)
}

phen15471 <- load_phenotype("phen15471.csv")
phen46234 <- load_phenotype("phen46234.csv")
phen71989 <- load_phenotype("phen71989.csv")

#### Merge expression and phenotypic data ####
merge_expr_phen <- function(expr, phen) {
  expr <- cbind(sample = rownames(expr), expr) %>%
    as.data.frame() %>%
    merge(phen, by = "sample") %>%
    column_to_rownames("sample")
  return(expr)
}

expr15471 <- merge_expr_phen(expr15471, phen15471)
expr46234 <- merge_expr_phen(expr46234, phen46234)
expr71989 <- merge_expr_phen(expr71989, phen71989)

#### Merging datasets ####
expr15471 <- cbind(batch = rep(1, nrow(expr15471)), expr15471)
expr46234 <- cbind(batch = rep(2, nrow(expr46234)), expr46234)
expr71989 <- cbind(batch = rep(3, nrow(expr71989)), expr71989)

mergedExpr <- bind_rows(expr15471, expr46234, expr71989) %>%
  mutate(group = as.factor(group), group = as.numeric(factor(group))) %>%
  mutate(across(3:ncol(.), as.numeric))

write.csv(mergedExpr, "mergeDatasets.csv")
